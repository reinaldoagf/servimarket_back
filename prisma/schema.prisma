// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum BusinessType {
  minimercado
  supermercado
  hypermercado
  farmacia
  panaderia
  otro
}

enum PurchaseStatus {
  pendiente
  pagado
  caducado
}

enum UserStatus {
  activo
  inactivo
}

enum ProductPacking {
  botella
  bolsa
  caja
  paquete
  envase
  otro
}

enum UnitMeasurement {
  noaplica
  kilogramos
  gramos
  miligramos
  kilolitros
  litros
  mililitros
}

enum PriceCalculation {
  unidad
  unidadDeMedida
}

enum ProductStatus {
  activo
  inactivo
  revisar
}

enum PermissionType {
  vista
  actualizar
  eliminar
}

//
// MODELOS
//

model Role {
  id           String            @id @default(uuid())
  key          String            @unique
  name         String
  users        User[]
  permissions  RolePermission[]
  pages        RolePage[]
  createdAt    DateTime          @default(now())
}

model Permission {
  id           String            @id @default(uuid())
  type         PermissionType    @unique
  roles        RolePermission[]
  createdAt    DateTime          @default(now())
}

// tabla puente Role ↔ Permission
model RolePermission {
  roleId       String
  permissionId String
  role         Role            @relation(fields: [roleId], references: [id])
  permission   Permission      @relation(fields: [permissionId], references: [id])
  createdAt DateTime  @default(now())

  @@id([roleId, permissionId])
}

// tabla para páginas de un rol
model RolePage {
  id         String    @id @default(uuid())
  page       String
  roleId     String
  role       Role      @relation(fields: [roleId], references: [id])
  createdAt  DateTime  @default(now())
}

model User {
  id                           String          @id @default(uuid())
  avatar                       String?
  name                         String
  email                        String          @unique
  username                     String          @unique
  dni                          String?         @unique
  dniFile                      String?
  password                     String    
  status                       UserStatus      @default(activo)
  hasAllPermissions            Boolean         @default(false)
  emailVerifiedAt              DateTime?
  verificationToken            String?

  roleId                       String?
  role                         Role?           @relation(fields: [roleId], references: [id])

  country                      String          @default("venezuela")
  state                        String
  city                         String

  businessId                   String?
  // Relación opcional con Business
  business                     Business?       @relation("BusinessOwner")

  // relaciones
  createdPendings              Pending[]       @relation("CreatedBy")
  linkedPendings               Pending[]       @relation("LinkedUser")

  collaborations               BusinessBranchCollaborator[]
  clients                      BusinessBranchClient[]
  suppliers                    BusinessBranchSupplier[]
  purchases                    BusinessBranchPurchase[]
  settings                     Setting[]
  salesByCategory              SaleByCategory[]
  purchasesByCategory          PurchaseByCategory[]
  cashRegisterClosingHistory   CashRegisterClosingHistory[]
  createdAt                    DateTime        @default(now())
}

model ProductBrand {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
}

model ProductCategory {
  id                  String    @id @default(uuid())
  name                String    @unique
  products            Product[]
  salesByCategory     SaleByCategory[]
  purchasesByCategory PurchaseByCategory[]
  createdAt           DateTime  @default(now())
}

model Product {
  id                     String                @id @default(uuid())
  barcode                String?
  name                   String
  flavor                 String?
  smell                  String?
  measurement            Float?
  exemptFromVAT          Boolean               @default(true) // exentos del incremento del IVA
  unitMeasurement        UnitMeasurement?      @default(gramos)
  priceCalculation       PriceCalculation?     @default(unidad)
  packing                ProductPacking        @default(bolsa)
  status                 ProductStatus         @default(activo)
  categoryId             String?
  category               ProductCategory?      @relation(fields: [categoryId], references: [id])
  brandId                String?
  brand                  ProductBrand?         @relation(fields: [brandId], references: [id])
  businessRef            String?
  businessId             String?
  business               Business?             @relation(fields: [businessId], references: [id])
  stocks                 ProductStock[]
  tags                   ProductTag[]
  purchases              Purchase[]
  createdAt              DateTime              @default(now())

  @@unique([barcode, name, flavor, smell, measurement])
}

// tabla para tags de productos
model ProductTag {
  id                     String          @id @default(uuid())
  tag                    String
  productRef             String?
  productId              String?
  product                Product?         @relation(fields: [productId], references: [id])
  createdAt              DateTime        @default(now())
}

model ProductStock {
  id                   String           @id @default(uuid())
  availables           Float            @default(0.0)
  salePrice            Float            @default(0.0)
  purchasePrice        Float            @default(0.0)
  profitPercentage     Float            @default(0.0)
  returnOnInvestment   Float            @default(0.0)
  productRef           String?
  productId            String?
  product              Product?         @relation(fields: [productId], references: [id])
  branchRef            String?
  branchId             String?
  branch               BusinessBranch?  @relation(fields: [branchId], references: [id])
  createdAt            DateTime         @default(now())
  purchases            Purchase[]
  
  @@unique([productId, branchId])
}

model Pending {
  id            String          @id @default(uuid())
  title         String
  message       String
  eventDate     DateTime?
  businessRef   String?
  businessId    String?
  business      Business?       @relation(fields: [businessId], references: [id])
  branchRef     String?
  branchId      String?
  branch        BusinessBranch? @relation(fields: [branchId], references: [id])
  createdById   String?
  createdBy     User?           @relation("CreatedBy", fields: [createdById], references: [id])
  linkedUserId  String?
  linkedUser    User?           @relation("LinkedUser", fields: [linkedUserId], references: [id])
  createdAt     DateTime        @default(now())
}

model SubscriptionPlan {
  id                 String        @id @default(uuid())
  title              String
  price              Float
  quantityProducts   Int?
  quantityBranches   Int?
  proFunctions       Boolean
  businesses         Business[]
  createdAt          DateTime  @default(now())
}

model Business {
  id                        String            @id @default(uuid())
  rif                       String?
  logo                      String?
  ownerId                   String            @unique
  owner                     User              @relation("BusinessOwner", fields: [ownerId], references: [id])
  name                      String
  type                      BusinessType      @default(minimercado)
  applyVAT                  Boolean           @default(true)
  branches                  BusinessBranch[]
  subscriptionPlanId        String?
  subscriptionPlan          SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  subscriptionDate          DateTime
  expirationDate            DateTime
  pendings                  Pending[]
  products                  Product[]
  settings                  Setting[]
  cashRegisters             CashRegister[]
  salesByCategory           SaleByCategory[]
  // relación 1:N con usuarios (empleados/miembros)
  /* users User[] @relation("BusinessUsers") */
  createdAt                 DateTime         @default(now())
}

model BusinessBranch {
  id                           String                       @id @default(uuid())
  businessId                   String?
  business                     Business?                    @relation(fields: [businessId], references: [id])
  country                      String                       @default("venezuela")
  state                        String
  city                         String
  address                      String
  phone                        String
  schedule247                  Boolean                      @default(false)
  itsOpen                      Boolean                      @default(true)
  businessHours                Json?
  stocks                       ProductStock[]
  collaborators                BusinessBranchCollaborator[]
  clients                      BusinessBranchClient[]
  suppliers                    BusinessBranchSupplier[]
  pendings                     Pending[]
  settings                     Setting[]
  cashRegisters                CashRegister[]
  salesByCategory              SaleByCategory[]
  cashRegisterClosingHistory   CashRegisterClosingHistory[]
  currencyId                   String?
  currency                     Currency?                    @relation(fields: [currencyId], references: [id])
  createdAt                    DateTime                     @default(now())
}

model CashRegister {
  id                         String                       @id @default(uuid())
  description                String?
  collaborator               BusinessBranchCollaborator?
  businessRef                String?
  businessId                 String?
  business                   Business?                    @relation(fields: [businessId], references: [id])
  branchRef                  String?
  branchId                   String?
  branch                     BusinessBranch?              @relation(fields: [branchId], references: [id])
  purchases                  BusinessBranchPurchase[]
  cashResgiterClosingHistory CashRegisterClosingHistory[]
  createdAt                  DateTime                     @default(now())
}

model CashRegisterClosingHistory {
  id                String                              @id @default(uuid())
  closedCount       Int                                 @default(1)
  totalClosedAmount Float                               @default(0.0)
  closingDate       DateTime
  branchRef         String?
  branchId          String?
  branch            BusinessBranch?                     @relation(fields: [branchId], references: [id])
  closedByRef       String?
  closedById        String?
  closedBy          User?                               @relation(fields: [closedById], references: [id])
  cashRegisterRef   String?
  cashRegisterId    String?
  cashRegister      CashRegister?                       @relation(fields: [cashRegisterId], references: [id])
  closedSales       BusinessBranchPurchaseClosedSale[]
  createdAt         DateTime                            @default(now())
}

model BusinessBranchPurchaseClosedSale {
  id                             String                       @id @default(uuid())
  businessBranchPurchaseRef      String?
  businessBranchPurchaseId       String?
  businessBranchPurchase         BusinessBranchPurchase?      @relation(fields: [businessBranchPurchaseId], references: [id])
  cashRegisterClosingHistoryRef  String?
  cashRegisterClosingHistoryId   String?
  cashRegisterClosingHistory     CashRegisterClosingHistory?  @relation(fields: [cashRegisterClosingHistoryId], references: [id])
  createdAt                      DateTime                     @default(now())
}

model BusinessBranchCollaborator {
  id                String                      @id @default(uuid())
  userId            String
  user              User                        @relation(fields: [userId], references: [id])
  branchId          String
  branch            BusinessBranch              @relation(fields: [branchId], references: [id])
  cashRegisterId    String?                     @unique
  cashRegister      CashRegister?               @relation(fields: [cashRegisterId], references: [id])
  isAdmin           Boolean                     @default(false)
  createdAt         DateTime                    @default(now())
}

model BusinessBranchClient {
  id          String          @id @default(uuid())
  clientName  String?
  clientDNI   String?
  userId      String?
  branchId    String
  user        User?           @relation(fields: [userId], references: [id])
  branch      BusinessBranch  @relation(fields: [branchId], references: [id])
  createdAt   DateTime        @default(now())
}

model BusinessBranchSupplier {
  id        String         @id @default(uuid())
  userId    String
  branchId  String
  user      User           @relation(fields: [userId], references: [id])
  branch    BusinessBranch @relation(fields: [branchId], references: [id])
  createdAt DateTime       @default(now())
}

model PurchaseByCategory {
  id            String           @id @default(uuid())
  total         Float            @default(0.0)
  userRef       String?
  userId        String?
  user          User?            @relation(fields: [userId], references: [id])
  categoryRef   String?
  categoryId    String?
  category      ProductCategory? @relation(fields: [categoryId], references: [id])
  createdAt     DateTime         @default(now())
}

model SaleByCategory {
  id            String           @id @default(uuid())
  total         Float            @default(0.0)
  userRef       String?
  userId        String?
  user          User?            @relation(fields: [userId], references: [id])
  categoryRef   String?
  categoryId    String?
  category      ProductCategory? @relation(fields: [categoryId], references: [id])
  businessRef   String?
  businessId    String?
  business      Business?        @relation(fields: [businessId], references: [id])
  branchRef     String?
  branchId      String?
  branch        BusinessBranch?  @relation(fields: [branchId], references: [id])
  createdAt     DateTime         @default(now())
}

model Purchase {
  id                         String                  @id @default(uuid())
  businessBranchPurchaseRef  String?
  businessBranchPurchaseId   String?
  businessBranchPurchase     BusinessBranchPurchase?  @relation(fields: [businessBranchPurchaseId], references: [id])
  productRef                 String?
  productId                  String?
  product                    Product?                 @relation(fields: [productId], references: [id])
  productStockRef            String?
  productStockId             String?
  productStock               ProductStock?           @relation(fields: [productStockId], references: [id])
  unitsOrMeasures            Float                   @default(1.0)
  price                      Float                   @default(0.0)
  createdAt                  DateTime                @default(now())
}

model BusinessBranchPurchase { // Factura
  id                                String          @id @default(uuid())
  ticketNumber                      Int?
  clientName                        String?
  clientDNI                         String?
  businessRef                       String?
  registeredRef                     String?
  cashRegisterRef                   String?
  branchRef                         String?
  cashRegisterId                    String?
  cashRegister                      CashRegister?   @relation(fields: [cashRegisterId], references: [id])
  userId                            String?
  user                              User?           @relation(fields: [userId], references: [id])
  amountCancelled                   Float
  totalAmount                       Float
  expiredDate                       DateTime?       //@default(dbgenerated("NOW() + INTERVAL 15 DAY"))
  closingDate                       DateTime?
  approvedByClient                  Boolean         @default(false)
  status                            PurchaseStatus  @default(pendiente)
  purchases                         Purchase[]
  purchasesBillPaymentMethod        PurchaseBillPaymentMethod[]
  businessBranchPurchaseClosedSale  BusinessBranchPurchaseClosedSale[]
  createdAt                         DateTime        @default(now())
}

model PurchaseBillPaymentMethod {
  id                        String                  @id @default(uuid())
  amountCancelled           Float                   @default(0.0)
  businessBranchPurchaseId  String?
  businessBranchPurchase    BusinessBranchPurchase? @relation(fields: [businessBranchPurchaseId], references: [id])
  billPaymentMethodId       String?
  billPaymentMethod         BillPaymentMethod?      @relation(fields: [billPaymentMethodId], references: [id])
  createdAt                 DateTime                @default(now())
}

model Setting { // configuraciones avanzadas
  id               String          @id @default(uuid())
  key              String
  country          String          @default("venezuela")
  floatValue       Float?
  stringValue      String?
  userId           String?
  user             User?           @relation(fields: [userId], references: [id])
  businessRef      String?
  businessId       String?
  business         Business?       @relation(fields: [businessId], references: [id])
  branchRef        String?
  branchId         String?
  branch           BusinessBranch? @relation(fields: [branchId], references: [id])
  createdAt        DateTime        @default(now())

  @@unique([key, userId, businessId, branchId])
}

model Currency {
  id                  String              @id @default(uuid())
  coin                String              @unique
  code                String              @unique
  symbol              String              @unique
  name                String
  country             String
  exchange            Float               @default(1.0)
  branches            BusinessBranch[]
  billPaymentMethods  BillPaymentMethod[]
  createdAt           DateTime            @default(now())
}

model BillPaymentMethod {
  id                          String            @id @default(uuid())
  name                        String            @unique
  image                       String?
  country                     String?
  currencyId                  String?
  currency                    Currency? @relation(fields: [currencyId], references: [id])
  purchasesBillPaymentMethod  PurchaseBillPaymentMethod[]
  createdAt                   DateTime          @default(now())

  @@unique([name, country])
}